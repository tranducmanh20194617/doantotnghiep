{"version":3,"file":"app_config_privacy_compliance_webhooks.js","sourceRoot":"","sources":["../../../../../src/cli/models/extensions/specifications/app_config_privacy_compliance_webhooks.ts"],"names":[],"mappings":"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","sourcesContent":["import {ComplianceTopic, WebhookSchema, WebhookSimplifyConfig} from './app_config_webhook.js'\nimport {WebhookSubscription, WebhooksConfig} from './types/app_config_webhook.js'\nimport {CustomTransformationConfig, createConfigExtensionSpecification} from '../specification.js'\nimport {Flag} from '../../../services/dev/fetch.js'\nimport {compact, getPathValue} from '@shopify/cli-kit/common/object'\n\nconst PrivacyComplianceWebhooksTransformConfig: CustomTransformationConfig = {\n  forward: (content: object, options?: {flags?: Flag[]}) => transformToPrivacyComplianceWebhooksModule(content),\n  reverse: (content: object, options?: {flags?: Flag[]}) =>\n    transformFromPrivacyComplianceWebhooksModule(content, options),\n}\n\nexport const PrivacyComplianceWebhooksSpecIdentifier = 'privacy_compliance_webhooks'\n\n// Uses the same schema as the webhooks specs because its content is nested under the same webhooks section\nconst appPrivacyComplienceSpec = createConfigExtensionSpecification({\n  identifier: PrivacyComplianceWebhooksSpecIdentifier,\n  schema: WebhookSchema,\n  transformConfig: PrivacyComplianceWebhooksTransformConfig,\n  simplify: WebhookSimplifyConfig,\n})\n\nexport default appPrivacyComplienceSpec\n\nfunction transformToPrivacyComplianceWebhooksModule(content: object) {\n  const webhooks = getPathValue(content, 'webhooks') as WebhooksConfig\n\n  return compact({\n    customers_redact_url: getCustomersDeletionUri(webhooks),\n    customers_data_request_url: getCustomersDataRequestUri(webhooks),\n    shop_redact_url: getShopDeletionUri(webhooks),\n  })\n}\n\nfunction transformFromPrivacyComplianceWebhooksModule(content: object, options?: {flags?: Flag[]}) {\n  const customersRedactUrl = getPathValue(content, 'customers_redact_url') as string\n  const customersDataRequestUrl = getPathValue(content, 'customers_data_request_url') as string\n  const shopRedactUrl = getPathValue(content, 'shop_redact_url') as string\n\n  if (options?.flags?.includes(Flag.DeclarativeWebhooks)) {\n    const webhooks: WebhookSubscription[] = []\n    if (customersRedactUrl) {\n      webhooks.push({compliance_topics: [ComplianceTopic.CustomersRedact], uri: customersRedactUrl})\n    }\n    if (customersDataRequestUrl) {\n      webhooks.push({compliance_topics: [ComplianceTopic.CustomersDataRequest], uri: customersDataRequestUrl})\n    }\n    if (shopRedactUrl) {\n      webhooks.push({compliance_topics: [ComplianceTopic.ShopRedact], uri: shopRedactUrl})\n    }\n\n    if (webhooks.length === 0) return {}\n    return {webhooks: {subscriptions: webhooks, privacy_compliance: undefined}}\n  }\n\n  if (customersRedactUrl || customersDataRequestUrl || shopRedactUrl) {\n    return {\n      webhooks: {\n        privacy_compliance: {\n          ...(customersRedactUrl ? {customer_deletion_url: customersRedactUrl} : {}),\n          ...(customersDataRequestUrl ? {customer_data_request_url: customersDataRequestUrl} : {}),\n          ...(shopRedactUrl ? {shop_deletion_url: shopRedactUrl} : {}),\n        },\n      },\n    }\n  }\n  return {}\n}\n\nfunction getComplianceUri(webhooks: WebhooksConfig, complianceTopic: string): string | undefined {\n  return webhooks.subscriptions?.find((subscription) => subscription.compliance_topics?.includes(complianceTopic))?.uri\n}\n\nfunction getCustomersDeletionUri(webhooks: WebhooksConfig) {\n  return getComplianceUri(webhooks, 'customers/redact') || webhooks?.privacy_compliance?.customer_deletion_url\n}\n\nfunction getCustomersDataRequestUri(webhooks: WebhooksConfig) {\n  return getComplianceUri(webhooks, 'customers/data_request') || webhooks?.privacy_compliance?.customer_data_request_url\n}\n\nfunction getShopDeletionUri(webhooks: WebhooksConfig) {\n  return getComplianceUri(webhooks, 'shop/redact') || webhooks?.privacy_compliance?.shop_deletion_url\n}\n"]}