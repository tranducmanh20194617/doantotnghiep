{"version":3,"file":"app_config_webhook.js","sourceRoot":"","sources":["../../../../../src/cli/models/extensions/specifications/app_config_webhook.ts"],"names":[],"mappings":"AAAA,OAAO,EAAC,wBAAwB,EAAE,0BAA0B,EAAC,MAAM,mCAAmC,CAAA;AACtG,OAAO,EAAC,aAAa,EAAE,mBAAmB,EAAC,MAAM,wBAAwB,CAAA;AACzE,OAAO,EAAC,gBAAgB,EAAC,MAAM,oCAAoC,CAAA;AAGnE,OAAO,EAA6C,kCAAkC,EAAC,MAAM,qBAAqB,CAAA;AAClH,OAAO,EAAC,GAAG,EAAC,MAAM,8BAA8B,CAAA;AAEhD,MAAM,CAAN,IAAY,eAIX;AAJD,WAAY,eAAe;IACzB,uDAAoC,CAAA;IACpC,kEAA+C,CAAA;IAC/C,6CAA0B,CAAA;AAC5B,CAAC,EAJW,eAAe,KAAf,eAAe,QAI1B;AAED,MAAM,yBAAyB,GAAG,GAAG,CAAC,MAAM,CAAC;IAC3C,MAAM,EAAE,GAAG;SACR,KAAK,CAAC,GAAG,CAAC,MAAM,CAAC,EAAC,kBAAkB,EAAE,sCAAsC,EAAC,CAAC,EAAE;QAC/E,kBAAkB,EAAE,wBAAwB;KAC7C,CAAC;SACD,QAAQ,EAAE;IACb,GAAG,EAAE,GAAG,CAAC,UAAU,CAAC,mBAAmB,EAAE,aAAa,EAAE,EAAC,cAAc,EAAE,kBAAkB,EAAC,CAAC;IAC7F,SAAS,EAAE,GAAG,CAAC,MAAM,CAAC,EAAC,kBAAkB,EAAE,wBAAwB,EAAC,CAAC,CAAC,QAAQ,EAAE;IAChF,cAAc,EAAE,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,MAAM,CAAC,EAAC,kBAAkB,EAAE,wBAAwB,EAAC,CAAC,CAAC,CAAC,QAAQ,EAAE;IAChG,oBAAoB,EAAE,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,MAAM,CAAC,EAAC,kBAAkB,EAAE,wBAAwB,EAAC,CAAC,CAAC,CAAC,QAAQ,EAAE;IACtG,iBAAiB,EAAE,GAAG;SACnB,KAAK,CACJ,GAAG,CAAC,IAAI,CAAC,CAAC,eAAe,CAAC,eAAe,EAAE,eAAe,CAAC,oBAAoB,EAAE,eAAe,CAAC,UAAU,CAAC,CAAC,EAC7G;QACE,kBAAkB,EAChB,mGAAmG;KACtG,CACF;SACA,QAAQ,EAAE;CACd,CAAC,CAAA;AAEF,MAAM,cAAc,GAAG,GAAG,CAAC,MAAM,CAAC;IAChC,WAAW,EAAE,GAAG,CAAC,MAAM,CAAC,EAAC,cAAc,EAAE,oBAAoB,EAAC,CAAC;IAC/D,kBAAkB,EAAE,GAAG;SACpB,MAAM,CAAC;QACN,qBAAqB,EAAE,aAAa,CAAC,QAAQ,EAAE;QAC/C,yBAAyB,EAAE,aAAa,CAAC,QAAQ,EAAE;QACnD,iBAAiB,EAAE,aAAa,CAAC,QAAQ,EAAE;KAC5C,CAAC;SACD,QAAQ,EAAE;IACb,aAAa,EAAE,GAAG,CAAC,KAAK,CAAC,yBAAyB,CAAC,CAAC,QAAQ,EAAE;CAC/D,CAAC,CAAA;AAEF,MAAM,CAAC,MAAM,6BAA6B,GAAG,cAAc,CAAC,WAAW,CAAC,gBAAgB,CAAC,CAAA;AAEzF,MAAM,CAAC,MAAM,aAAa,GAAG,GAAG,CAAC,MAAM,CAAC;IACtC,QAAQ,EAAE,6BAA6B;CACxC,CAAC,CAAA;AAEF,MAAM,CAAC,MAAM,sBAAsB,GAAG,UAAU,CAAA;AAEhD,MAAM,sBAAsB,GAA+B;IACzD,OAAO,EAAE,CAAC,OAAe,EAAE,EAAE,CAAC,0BAA0B,CAAC,OAAO,CAAC;IACjE,OAAO,EAAE,CAAC,OAAe,EAAE,EAAE,CAAC,wBAAwB,CAAC,OAAO,CAAC;CAChE,CAAA;AAED,MAAM,CAAC,MAAM,qBAAqB,GAAmB;IACnD,QAAQ,EAAE,CAAC,YAAmC,EAAE,EAAE,CAAC,gBAAgB,CAAC,YAAY,CAAC;CAClF,CAAA;AAED,MAAM,eAAe,GAAG,kCAAkC,CAAC;IACzD,UAAU,EAAE,sBAAsB;IAClC,MAAM,EAAE,aAAa;IACrB,eAAe,EAAE,sBAAsB;IACvC,QAAQ,EAAE,qBAAqB;CAChC,CAAC,CAAA;AAEF,eAAe,eAAe,CAAA;AAE9B,SAAS,gBAAgB,CAAC,YAAmC;IAC3D,IAAI,CAAC,YAAY,CAAC,QAAQ,EAAE,aAAa;QAAE,OAAO,YAAY,CAAA;IAE9D,YAAY,CAAC,QAAQ,CAAC,aAAa,GAAG,aAAa,CAAC,YAAY,CAAC,QAAQ,CAAC,aAAa,CAAC,CAAA;IACxF,OAAO,YAAY,CAAA;AACrB,CAAC;AAED,SAAS,aAAa,CAAC,aAAoC;IACzD,OAAO,aAAa,CAAC,MAAM,CAAC,CAAC,WAAW,EAAE,YAAY,EAAE,EAAE;QACxD,MAAM,oBAAoB,GAAG,WAAW,CAAC,IAAI,CAC3C,CAAC,GAAG,EAAE,EAAE,CACN,GAAG,CAAC,GAAG,KAAK,YAAY,CAAC,GAAG;YAC5B,GAAG,CAAC,SAAS,KAAK,YAAY,CAAC,SAAS;YACxC,GAAG,CAAC,cAAc,KAAK,YAAY,CAAC,cAAc;YAClD,GAAG,CAAC,oBAAoB,KAAK,YAAY,CAAC,oBAAoB,CACjE,CAAA;QACD,IAAI,oBAAoB,EAAE;YACxB,IAAI,YAAY,CAAC,iBAAiB,EAAE;gBAClC,oBAAoB,CAAC,iBAAiB,KAAtC,oBAAoB,CAAC,iBAAiB,GAAK,EAAE,EAAA;gBAC7C,oBAAoB,CAAC,iBAAiB,CAAC,IAAI,CAAC,GAAG,YAAY,CAAC,iBAAiB,CAAC,CAAA;aAC/E;YACD,IAAI,YAAY,CAAC,MAAM,EAAE;gBACvB,oBAAoB,CAAC,MAAM,KAA3B,oBAAoB,CAAC,MAAM,GAAK,EAAE,EAAA;gBAClC,oBAAoB,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,YAAY,CAAC,MAAM,CAAC,CAAA;aACzD;SACF;aAAM;YACL,WAAW,CAAC,IAAI,CAAC,YAAY,CAAC,CAAA;SAC/B;QACD,OAAO,WAAW,CAAA;IACpB,CAAC,EAAE,EAA2B,CAAC,CAAA;AACjC,CAAC","sourcesContent":["import {transformToWebhookConfig, transformFromWebhookConfig} from './transform/app_config_webhook.js'\nimport {UriValidation, removeTrailingSlash} from './validation/common.js'\nimport {webhookValidator} from './validation/app_config_webhook.js'\nimport {WebhookSubscription} from './types/app_config_webhook.js'\nimport {SpecsAppConfiguration} from './types/app_config.js'\nimport {CustomTransformationConfig, SimplifyConfig, createConfigExtensionSpecification} from '../specification.js'\nimport {zod} from '@shopify/cli-kit/node/schema'\n\nexport enum ComplianceTopic {\n  CustomersRedact = 'customers/redact',\n  CustomersDataRequest = 'customers/data_request',\n  ShopRedact = 'shop/redact',\n}\n\nconst WebhookSubscriptionSchema = zod.object({\n  topics: zod\n    .array(zod.string({invalid_type_error: 'Values within array must be a string'}), {\n      invalid_type_error: 'Value must be string[]',\n    })\n    .optional(),\n  uri: zod.preprocess(removeTrailingSlash, UriValidation, {required_error: 'Missing value at'}),\n  sub_topic: zod.string({invalid_type_error: 'Value must be a string'}).optional(),\n  include_fields: zod.array(zod.string({invalid_type_error: 'Value must be a string'})).optional(),\n  metafield_namespaces: zod.array(zod.string({invalid_type_error: 'Value must be a string'})).optional(),\n  compliance_topics: zod\n    .array(\n      zod.enum([ComplianceTopic.CustomersRedact, ComplianceTopic.CustomersDataRequest, ComplianceTopic.ShopRedact]),\n      {\n        invalid_type_error:\n          'Value must be an array containing values: customers/redact, customers/data_request or shop/redact',\n      },\n    )\n    .optional(),\n})\n\nconst WebhooksSchema = zod.object({\n  api_version: zod.string({required_error: 'String is required'}),\n  privacy_compliance: zod\n    .object({\n      customer_deletion_url: UriValidation.optional(),\n      customer_data_request_url: UriValidation.optional(),\n      shop_deletion_url: UriValidation.optional(),\n    })\n    .optional(),\n  subscriptions: zod.array(WebhookSubscriptionSchema).optional(),\n})\n\nexport const WebhooksSchemaWithDeclarative = WebhooksSchema.superRefine(webhookValidator)\n\nexport const WebhookSchema = zod.object({\n  webhooks: WebhooksSchemaWithDeclarative,\n})\n\nexport const WebhooksSpecIdentifier = 'webhooks'\n\nconst WebhookTransformConfig: CustomTransformationConfig = {\n  forward: (content: object) => transformFromWebhookConfig(content),\n  reverse: (content: object) => transformToWebhookConfig(content),\n}\n\nexport const WebhookSimplifyConfig: SimplifyConfig = {\n  simplify: (remoteConfig: SpecsAppConfiguration) => simplifyWebhooks(remoteConfig),\n}\n\nconst appWebhooksSpec = createConfigExtensionSpecification({\n  identifier: WebhooksSpecIdentifier,\n  schema: WebhookSchema,\n  transformConfig: WebhookTransformConfig,\n  simplify: WebhookSimplifyConfig,\n})\n\nexport default appWebhooksSpec\n\nfunction simplifyWebhooks(remoteConfig: SpecsAppConfiguration) {\n  if (!remoteConfig.webhooks?.subscriptions) return remoteConfig\n\n  remoteConfig.webhooks.subscriptions = mergeWebhooks(remoteConfig.webhooks.subscriptions)\n  return remoteConfig\n}\n\nfunction mergeWebhooks(subscriptions: WebhookSubscription[]): WebhookSubscription[] {\n  return subscriptions.reduce((accumulator, subscription) => {\n    const existingSubscription = accumulator.find(\n      (sub) =>\n        sub.uri === subscription.uri &&\n        sub.sub_topic === subscription.sub_topic &&\n        sub.include_fields === subscription.include_fields &&\n        sub.metafield_namespaces === subscription.metafield_namespaces,\n    )\n    if (existingSubscription) {\n      if (subscription.compliance_topics) {\n        existingSubscription.compliance_topics ??= []\n        existingSubscription.compliance_topics.push(...subscription.compliance_topics)\n      }\n      if (subscription.topics) {\n        existingSubscription.topics ??= []\n        existingSubscription.topics.push(...subscription.topics)\n      }\n    } else {\n      accumulator.push(subscription)\n    }\n    return accumulator\n  }, [] as WebhookSubscription[])\n}\n"]}