{"version":3,"file":"generate-schema.js","sourceRoot":"","sources":["../../../src/cli/services/generate-schema.ts"],"names":[],"mappings":"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","sourcesContent":["import {fetchOrCreateOrganizationApp} from './context.js'\nimport {DeveloperPlatformClient, selectDeveloperPlatformClient} from '../utilities/developer-platform-client.js'\nimport {AppInterface} from '../models/app/app.js'\nimport {getAppIdentifiers} from '../models/app/identifiers.js'\nimport {ApiSchemaDefinitionQueryVariables} from '../api/graphql/functions/api_schema_definition.js'\nimport {TargetSchemaDefinitionQueryVariables} from '../api/graphql/functions/target_schema_definition.js'\nimport {ExtensionInstance} from '../models/extensions/extension-instance.js'\nimport {FunctionConfigType} from '../models/extensions/specifications/function.js'\nimport {isTerminalInteractive} from '@shopify/cli-kit/node/context/local'\nimport {AbortError} from '@shopify/cli-kit/node/error'\nimport {outputContent, outputInfo} from '@shopify/cli-kit/node/output'\nimport {writeFile} from '@shopify/cli-kit/node/fs'\nimport {joinPath} from '@shopify/cli-kit/node/path'\n\ninterface GenerateSchemaOptions {\n  app: AppInterface\n  extension: ExtensionInstance<FunctionConfigType>\n  apiKey?: string\n  stdout: boolean\n  path: string\n  developerPlatformClient?: DeveloperPlatformClient\n}\n\nexport async function generateSchemaService(options: GenerateSchemaOptions) {\n  const {extension, app} = options\n  const developerPlatformClient = options.developerPlatformClient ?? selectDeveloperPlatformClient()\n  const {api_version: version, type, targeting} = extension.configuration\n  let apiKey = options.apiKey || getAppIdentifiers({app}).app\n  const stdout = options.stdout\n\n  if (!apiKey) {\n    if (!isTerminalInteractive()) {\n      throw new AbortError(\n        outputContent`No Client ID was provided.`,\n        outputContent`Provide a Client ID with the --client-id flag.`,\n      )\n    }\n\n    apiKey = (await fetchOrCreateOrganizationApp(app, developerPlatformClient)).apiKey\n  }\n\n  const usingTargets = Boolean(targeting?.length)\n  const definition = await (usingTargets\n    ? generateSchemaFromTarget({\n        localIdentifier: extension.localIdentifier,\n        developerPlatformClient,\n        apiKey,\n        target: targeting![0]!.target,\n        version,\n      })\n    : generateSchemaFromType({\n        localIdentifier: extension.localIdentifier,\n        developerPlatformClient,\n        apiKey,\n        type,\n        version,\n      }))\n\n  if (stdout) {\n    outputInfo(definition)\n  } else {\n    const outputPath = joinPath(options.path, 'schema.graphql')\n    await writeFile(outputPath, definition)\n    outputInfo(`GraphQL Schema for ${extension.localIdentifier} written to ${outputPath}`)\n  }\n}\n\ninterface BaseGenerateSchemaOptions {\n  localIdentifier: string\n  developerPlatformClient: DeveloperPlatformClient\n  apiKey: string\n  version: string\n}\n\ninterface GenerateSchemaFromTargetOptions extends BaseGenerateSchemaOptions {\n  target: string\n}\n\nasync function generateSchemaFromTarget({\n  localIdentifier,\n  developerPlatformClient,\n  apiKey,\n  target,\n  version,\n}: GenerateSchemaFromTargetOptions): Promise<string> {\n  const variables: TargetSchemaDefinitionQueryVariables = {\n    apiKey,\n    target,\n    version,\n  }\n  const definition = await developerPlatformClient.targetSchemaDefinition(variables)\n\n  if (!definition) {\n    throw new AbortError(\n      outputContent`A schema could not be generated for ${localIdentifier}`,\n      outputContent`Check that the Function targets and version are valid.`,\n    )\n  }\n\n  return definition\n}\n\ninterface GenerateSchemaFromType extends BaseGenerateSchemaOptions {\n  type: string\n}\n\nasync function generateSchemaFromType({\n  localIdentifier,\n  developerPlatformClient,\n  apiKey,\n  version,\n  type,\n}: GenerateSchemaFromType): Promise<string> {\n  const variables: ApiSchemaDefinitionQueryVariables = {\n    apiKey,\n    version,\n    type,\n  }\n  const definition = await developerPlatformClient.apiSchemaDefinition(variables)\n\n  if (!definition) {\n    throw new AbortError(\n      outputContent`A schema could not be generated for ${localIdentifier}`,\n      outputContent`Check that the Function API type and version are valid.`,\n    )\n  }\n\n  return definition\n}\n"]}