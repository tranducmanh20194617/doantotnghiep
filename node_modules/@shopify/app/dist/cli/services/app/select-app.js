import { selectOrganizationPrompt, selectAppPrompt } from '../../prompts/dev.js';
import { fetchOrganizations } from '../dev/fetch.js';
import { selectDeveloperPlatformClient, } from '../../utilities/developer-platform-client.js';
import { deepMergeObjects } from '@shopify/cli-kit/common/object';
export async function selectApp() {
    const developerPlatformClient = selectDeveloperPlatformClient();
    const orgs = await fetchOrganizations(developerPlatformClient);
    const org = await selectOrganizationPrompt(orgs);
    const { apps, hasMorePages } = await developerPlatformClient.appsForOrg(org.id);
    const selectedAppApiKey = await selectAppPrompt(apps, hasMorePages, org.id, { developerPlatformClient });
    const selectedApp = apps.find((app) => app.apiKey === selectedAppApiKey);
    const fullSelectedApp = await developerPlatformClient.appFromId(selectedApp);
    return fullSelectedApp;
}
export async function fetchAppRemoteConfiguration(remoteApp, developerPlatformClient, specifications, flags) {
    const activeAppVersion = await developerPlatformClient.activeAppVersion(remoteApp);
    const appModuleVersionsConfig = activeAppVersion?.appModuleVersions.filter((module) => module.specification?.experience === 'configuration') || [];
    const remoteConfiguration = remoteAppConfigurationExtensionContent(appModuleVersionsConfig, specifications, flags);
    return specifications.reduce((simplifiedConfiguration, spec) => spec.simplify?.(simplifiedConfiguration) ?? simplifiedConfiguration, remoteConfiguration);
}
export function remoteAppConfigurationExtensionContent(configRegistrations, specifications, flags) {
    let remoteAppConfig = {};
    const configSpecifications = specifications.filter((spec) => spec.experience === 'configuration');
    configRegistrations.forEach((module) => {
        const configSpec = configSpecifications.find((spec) => spec.identifier === module.specification?.identifier.toLowerCase());
        if (!configSpec)
            return;
        const config = module.config;
        if (!config)
            return;
        remoteAppConfig = deepMergeObjects(remoteAppConfig, configSpec.reverseTransform?.(config, { flags }) ?? config);
    });
    return { ...remoteAppConfig };
}
//# sourceMappingURL=select-app.js.map