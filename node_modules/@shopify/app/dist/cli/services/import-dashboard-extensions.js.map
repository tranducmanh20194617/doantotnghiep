{"version":3,"file":"import-dashboard-extensions.js","sourceRoot":"","sources":["../../../src/cli/services/import-dashboard-extensions.ts"],"names":[],"mappings":"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","sourcesContent":["import {fetchAppAndIdentifiers, logMetadataForLoadedContext} from './context.js'\nimport {ensureExtensionDirectoryExists} from './extensions/common.js'\nimport {getActiveDashboardExtensions} from './fetch-dashboard-extensions.js'\nimport {AppInterface} from '../models/app/app.js'\nimport {updateAppIdentifiers, IdentifiersExtensions} from '../models/app/identifiers.js'\nimport {ExtensionRegistration} from '../api/graphql/all_app_extension_registrations.js'\nimport {DeveloperPlatformClient, selectDeveloperPlatformClient} from '../utilities/developer-platform-client.js'\nimport {renderSelectPrompt, renderSuccess} from '@shopify/cli-kit/node/ui'\nimport {basename, joinPath} from '@shopify/cli-kit/node/path'\nimport {writeFile} from '@shopify/cli-kit/node/fs'\nimport {outputContent} from '@shopify/cli-kit/node/output'\n\ninterface ImportOptions {\n  app: AppInterface\n  apiKey?: string\n  developerPlatformClient?: DeveloperPlatformClient\n  extensionTypes: string[]\n  buildTomlObject: (ext: ExtensionRegistration) => string\n}\n\nexport async function importDashboardExtensions(options: ImportOptions) {\n  const developerPlatformClient = options.developerPlatformClient ?? selectDeveloperPlatformClient()\n  const [remoteApp, _] = await fetchAppAndIdentifiers({...options, reset: false}, developerPlatformClient, false)\n\n  await logMetadataForLoadedContext(remoteApp)\n\n  const extensions = await getActiveDashboardExtensions({\n    developerPlatformClient,\n    apiKey: remoteApp.apiKey,\n    organizationId: remoteApp.organizationId,\n    extensionTypes: options.extensionTypes,\n  })\n\n  if (extensions.length === 0) {\n    renderSuccess({headline: ['No extensions to migrate.']})\n    return\n  }\n\n  const choices = extensions.map((ext) => {\n    return {label: ext.title, value: ext.uuid}\n  })\n  choices.push({label: 'All', value: 'All'})\n  const promptAnswer = await renderSelectPrompt({message: 'Extensions to migrate', choices})\n\n  const extensionsToMigrate =\n    promptAnswer === 'All' ? extensions : [extensions.find((ext) => ext?.uuid === promptAnswer)!]\n\n  const extensionUuids: IdentifiersExtensions = {}\n  const importPromises = extensionsToMigrate.map(async (ext) => {\n    const directory = await ensureExtensionDirectoryExists({app: options.app, name: ext.title})\n    const tomlObject = options.buildTomlObject(ext)\n    const path = joinPath(directory, 'shopify.extension.toml')\n    await writeFile(path, tomlObject)\n    extensionUuids[ext.title] = ext.uuid\n    return {extension: ext, directory: joinPath('extensions', basename(directory))}\n  })\n\n  const generatedExtensions = await Promise.all(importPromises)\n  renderSuccessMessages(generatedExtensions)\n  await updateAppIdentifiers({\n    app: options.app,\n    identifiers: {extensions: extensionUuids, app: remoteApp.apiKey},\n    command: 'deploy',\n  })\n}\n\nfunction renderSuccessMessages(generatedExtensions: {extension: ExtensionRegistration; directory: string}[]) {\n  renderSuccess({\n    headline: ['Imported the following extensions from the dashboard:'],\n    body: generatedExtensions\n      .map((gen) => {\n        return outputContent`â€¢ \"${gen.extension.title}\" at: ${gen.directory}`.value\n      })\n      .join('\\n'),\n  })\n}\n"]}