{"version":3,"file":"spin.js","sourceRoot":"","sources":["../../../../src/public/node/context/spin.ts"],"names":[],"mappings":"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","sourcesContent":["import {isTruthy} from './utilities.js'\nimport {fileExists, readFile, readFileSync} from '../fs.js'\nimport {environmentVariables} from '../../../private/node/constants.js'\nimport {captureOutput} from '../system.js'\nimport {outputContent, outputToken} from '../output.js'\nimport {getCachedSpinFqdn, setCachedSpinFqdn} from '../../../private/node/context/spin-cache.js'\nimport {AbortError} from '../error.js'\nimport {Environment, serviceEnvironment} from '../../../private/node/context/service.js'\nimport {joinPath} from '../path.js'\n\nconst SpinInstanceNotFoundMessages = (spinInstance: string | undefined, error: string) => {\n  const errorMessage = outputContent`${outputToken.genericShellCommand(\n    `spin`,\n  )} yielded the following error trying to obtain the fully qualified domain name of the Spin instance:\n${error}\n  `\n  let nextSteps: string | undefined\n  if (spinInstance) {\n    nextSteps = `Make sure ${spinInstance} is the instance name and not a fully qualified domain name`\n  }\n  return {errorMessage, nextSteps}\n}\n\nconst spinFqdnFilePath = '/etc/spin/machine/fqdn'\n\n/**\n * When ran in a Spin environment, it returns the fqdn of the instance.\n *\n * Will cache the value of the Spin FQDN during the execution of the CLI.\n * To avoid multiple calls to `readSync` or `show`.\n *\n * @param env - Environment variables.\n * @returns Fqdn of the Spin environment.\n */\nexport async function spinFqdn(env = process.env): Promise<string> {\n  let spinFqdn = getCachedSpinFqdn()\n  if (spinFqdn) return spinFqdn\n\n  if (await fileExists(spinFqdnFilePath)) {\n    spinFqdn = await readFileSync(spinFqdnFilePath).toString()\n  } else {\n    const spinInstance = await instance(env)\n    const showResponse = await show(spinInstance, env)\n\n    spinFqdn = showResponse.fqdn\n  }\n  setCachedSpinFqdn(spinFqdn)\n  return spinFqdn\n}\n\n/**\n * Runs \"spin show\" and returns the JSON-parsed output.\n *\n * @param spinInstance - When it's undefined, we'll fetch the latest one.\n * @param env - Environment variables.\n * @returns The JSON-parsed output of the Spin CLI.\n * @throws Any error raised from the underlying Spin CLI.\n */\nexport async function show(spinInstance: string | undefined, env = process.env): Promise<{fqdn: string}> {\n  const latest = spinInstance === undefined\n  const args = latest ? ['show', '--latest', '--json'] : ['show', '--json']\n  const output = await captureOutput('spin', args, {env})\n  const json = JSON.parse(output)\n  if (json.error) {\n    const {errorMessage, nextSteps} = SpinInstanceNotFoundMessages(spinInstance, json.error)\n    throw new AbortError(errorMessage, nextSteps)\n  } else {\n    return json\n  }\n}\n\n/**\n * Returns true if the CLI is running in a Spin environment.\n *\n * @param env - Environment variables.\n * @returns True if the CLI is running in a Spin environment.\n */\nexport function isSpin(env = process.env): boolean {\n  return isTruthy(env[environmentVariables.spin])\n}\n\n/**\n * Returns the value of the SPIN_INSTANCE environment variable.\n *\n * @param env - Environment variables.\n * @returns The value of the SPIN_INSTANCE environment variable.\n */\nexport function instance(env = process.env): string | undefined {\n  return env[environmentVariables.spinInstance]\n}\n\n/**\n * Returns true if the CLI is running in a Spin environment.\n *\n * @param env - Environment variables.\n * @returns True if the CLI is running in a Spin environment.\n */\nexport function isSpinEnvironment(env = process.env): boolean {\n  return serviceEnvironment(env) === Environment.Spin\n}\n\n/**\n * Returns the value of the SERVER_PORT environment variable.\n *\n * @param env - Environment variables.\n * @returns The value of the SERVER_PORT environment variable.\n */\nexport function appPort(env = process.env): number | undefined {\n  const port = Number(env[environmentVariables.spinAppPort])\n  return (!isNaN(port) && port) || undefined\n}\n\n/**\n * Returns the value of the SPIN_APP_HOST environment variable.\n *\n * @param env - Environment variables.\n * @returns The value of the SPIN_APP_HOST environment variable.\n */\nexport function appHost(env = process.env): string | undefined {\n  return env[environmentVariables.spinAppHost]\n}\n\nexport const spinVariables = {\n  partnersSpinService: 'shopify--partners',\n  manualCliSpinPortName: 'CLI_EXTENSION_SERVER',\n}\n/**\n * Fetches the port for a given spin service and port environment variable.\n *\n * @param service - The name of the spin service to fetch the port for.\n * @param portEnvName - The name of the environment variable to fetch the port from.\n * @param basePath - The base path to look for the port file.\n * @returns The port number or undefined if the port could not be found.\n */\nexport async function fetchSpinPort(\n  service: string,\n  portEnvName: string,\n  basePath = '/run',\n): Promise<number | undefined> {\n  const spinVersionConfigurations = [\n    {\n      path: joinPath(basePath, 'ports2', service, 'custom', portEnvName),\n      contentPattern: /\\[{\"internal\":(\\d+)}\\]/,\n    },\n    {\n      path: joinPath(basePath, 'ports', service, 'proc', portEnvName),\n      contentPattern: /(\\d+)/,\n    },\n  ]\n  for (const config of spinVersionConfigurations) {\n    let fileContent: string\n\n    try {\n      // eslint-disable-next-line no-await-in-loop\n      fileContent = await readFile(config.path)\n      // eslint-disable-next-line no-catch-all/no-catch-all\n    } catch (error) {\n      continue\n    }\n\n    const match = config.contentPattern.exec(fileContent)\n    if (match && match[1] && !isNaN(parseInt(match[1], 10))) {\n      return parseInt(match[1], 10)\n    }\n  }\n\n  return undefined\n}\n"]}